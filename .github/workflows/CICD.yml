name: CI/CD Pipeline - ETL Data Pipelines

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  PYTHON_VERSION: '3.9'
  AIRFLOW_VERSION: '2.7.0'
  VM_HOST: ${{ secrets.VM_HOST }}
  VM_USER: ${{ secrets.VM_USER }}
  DEPLOY_ETL_FACOLOS_SECRET: ${{ secrets.DEPLOY_ETL_FACOLOS_SECRET }}

jobs:
  # Job 1: Test DAGs v√† Code Quality
  test-dags:
    runs-on: ubuntu-latest
    env:
      # Bi·∫øn m√¥i tr∆∞·ªùng t·ªëi thi·ªÉu ƒë·ªÉ tr√°nh c·∫£nh b√°o khi import settings trong CI
      SQL_SERVER_PASSWORD: "test"
      SQL_SERVER_DATABASE: "FacolosEnterpriseDW"
      TIKTOK_APP_SECRET: "test"
      TIKTOK_ACCESS_TOKEN: "test"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # C√†i ri√™ng google-re2 b·∫±ng wheel n·∫øu c√≥; n·∫øu kh√¥ng c√≥ wheel th√¨ b·ªè qua
        pip install --only-binary=:all: google-re2 || true
        # C√†i dependencies d·ª± √°n (cho ph√©p build t·ª´ source n·∫øu c·∫ßn)
        pip install -r requirements.txt
        # C√¥ng c·ª• ki·ªÉm th·ª≠ v√† lint
        pip install pytest pytest-cov flake8 black
        
    - name: Code formatting check v·ªõi Black
      run: |
        echo "Ki·ªÉm tra code formatting v·ªõi Black..."
        black --check --diff src/ dags/ config/
        
    - name: Linting v·ªõi Flake8
      run: |
        echo "Ki·ªÉm tra code quality v·ªõi Flake8..."
        flake8 src/ dags/ config/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/ dags/ config/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: Test DAG syntax v√† import
      run: |
        echo "Ki·ªÉm tra syntax v√† import c·ªßa c√°c DAGs..."
        python -c "
        import sys
        import os
        
        # S·ª≠a ƒë∆∞·ªùng d·∫´n cho GitHub Actions
        sys.path.append('.')
        
        # Test import c√°c modules
        try:
            from src.extractors.misa_crm_extractor import MISACRMExtractor
            from src.extractors.tiktok_shop_extractor import TikTokShopOrderExtractor
            from src.extractors.shopee_orders_extractor import ShopeeOrderExtractor
            from src.transformers.misa_crm_transformer import MISACRMTransformer
            from src.transformers.tiktok_shop_transformer import TikTokShopOrderTransformer
            from src.transformers.shopee_orders_transformer import ShopeeOrderTransformer
            from src.loaders.misa_crm_loader import MISACRMLoader
            from src.loaders.tiktok_shop_staging_loader import TikTokShopOrderLoader
            from src.loaders.shopee_orders_loader import ShopeeOrderLoader
            print('‚úÖ T·∫•t c·∫£ modules import th√†nh c√¥ng')
        except ImportError as e:
            print(f'‚ùå L·ªói import: {e}')
            sys.exit(1)
        "
        
    - name: Test DAG validation
      run: |
        echo "Ki·ªÉm tra validation c·ªßa c√°c DAGs..."
        python -c "
        import sys
        import os
        
        # S·ª≠a ƒë∆∞·ªùng d·∫´n cho GitHub Actions
        sys.path.append('.')
        
        # Test DAG validation
        try:
            # Test full_load_etl_dag
            with open('dags/full_load_etl_dag.py', 'r', encoding='utf-8') as f:
                dag_code = f.read()
            exec(dag_code)
            print('‚úÖ full_load_etl_dag validation th√†nh c√¥ng')
            
            # Test incremental_etl_dag  
            with open('dags/incremental_etl_dag.py', 'r', encoding='utf-8') as f:
                dag_code = f.read()
            exec(dag_code)
            print('‚úÖ incremental_etl_dag validation th√†nh c√¥ng')
            
        except Exception as e:
            print(f'‚ùå L·ªói validation DAG: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        "
        
    - name: Test configuration files
      run: |
        echo "Ki·ªÉm tra configuration files..."
        python -c "
        try:
            from config.settings import settings
            print('‚úÖ Settings import th√†nh c√¥ng')
        except Exception as e:
            print(f'‚ùå L·ªói settings: {e}')
            sys.exit(1)
        "
        
    - name: Test ch·ª©c nƒÉng DAGs v√† logic ETL
      run: |
        echo "Ki·ªÉm tra ch·ª©c nƒÉng DAGs v√† logic ETL..."
        python scripts/test_dag_functionality.py
        
    - name: Test database connections v√† loading logic
      run: |
        echo "Ki·ªÉm tra k·∫øt n·ªëi database v√† loading logic..."
        python -c "
        import sys
        import os
        import pandas as pd
        sys.path.append('/opt/airflow/')
        
        try:
            # Test SQL Server connection
            print('üîç Testing SQL Server connection...')
            from src.utils.database import DatabaseManager
            
            # Test connection string format
            db_manager = DatabaseManager()
            connection_string = db_manager.get_connection_string()
            
            if connection_string:
                print('‚úÖ SQL Server connection string ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng')
                print(f'Connection string format: {connection_string[:50]}...')
            else:
                print('‚ö†Ô∏è SQL Server connection string kh√¥ng ƒë∆∞·ª£c t·∫°o')
            
            # Test loaders
            print('üîç Testing database loaders...')
            from src.loaders.misa_crm_loader import MISACRMLoader
            from src.loaders.tiktok_shop_staging_loader import TikTokShopOrderLoader
            from src.loaders.shopee_orders_loader import ShopeeOrderLoader
            
            # Test MISA CRM loader
            misa_loader = MISACRMLoader()
            print(f'‚úÖ MISA CRM loader table mappings: {misa_loader.table_mappings}')
            
            # Test TikTok Shop loader
            tiktok_loader = TikTokShopOrderLoader()
            print('‚úÖ TikTok Shop loader instantiated successfully')
            
            # Test Shopee loader
            shopee_loader = ShopeeOrderLoader()
            print('‚úÖ Shopee loader instantiated successfully')
                
        except Exception as e:
            print(f'‚ö†Ô∏è Database connection test failed: {str(e)}')
            print('‚ö†Ô∏è C√≥ th·ªÉ do ch∆∞a c·∫•u h√¨nh database credentials')
        "
        
    - name: Test data transformation logic
      run: |
        echo "Ki·ªÉm tra logic transform d·ªØ li·ªáu..."
        python -c "
        import sys
        import os
        import pandas as pd
        
        # S·ª≠a ƒë∆∞·ªùng d·∫´n cho GitHub Actions
        sys.path.append('.')
        
        try:
            # Test MISA CRM transformer v·ªõi sample data
            print('üîç Testing MISA CRM transformer...')
            from src.transformers.misa_crm_transformer import MISACRMTransformer
            
            transformer = MISACRMTransformer()
            
            # T·∫°o sample data ƒë·ªÉ test - s·ª≠a syntax
            sample_data = {
                'customers': [{'id': 1, 'name': 'Test Customer', 'email': 'test@example.com'}],
                'contacts': [{'id': 1, 'customer_id': 1, 'phone': '0123456789'}]
            }
            
            try:
                transformed_data = transformer.transform_all_endpoints(sample_data)
                if transformed_data and len(transformed_data) > 0:
                    print('‚úÖ MISA CRM transformer ho·∫°t ƒë·ªông v·ªõi sample data')
                else:
                    print('‚ö†Ô∏è MISA CRM transformer kh√¥ng tr·∫£ v·ªÅ d·ªØ li·ªáu')
            except Exception as e:
                print(f'‚ö†Ô∏è MISA CRM transformer failed: {str(e)}')
            
            # Test TikTok Shop transformer v·ªõi sample data
            print('üîç Testing TikTok Shop transformer...')
            from src.transformers.tiktok_shop_transformer import TikTokShopOrderTransformer
            
            tiktok_transformer = TikTokShopOrderTransformer()
            
            # T·∫°o sample order data - s·ª≠a syntax
            sample_orders = [{
                'order_id': 'test_123',
                'order_status': 'COMPLETED',
                'create_time': 1640995200,
                'total_amount': 100000
            }]
            
            try:
                transformed_df = tiktok_transformer.transform_orders_to_dataframe(sample_orders)
                if not transformed_df.empty:
                    print('‚úÖ TikTok Shop transformer ho·∫°t ƒë·ªông v·ªõi sample data')
                    print(f'Sample transformed data shape: {transformed_df.shape}')
                else:
                    print('‚ö†Ô∏è TikTok Shop transformer kh√¥ng tr·∫£ v·ªÅ d·ªØ li·ªáu')
            except Exception as e:
                print(f'‚ö†Ô∏è TikTok Shop transformer failed: {str(e)}')
                
        except Exception as e:
            print(f'‚ùå L·ªói test data transformation: {e}')
            import traceback
            traceback.print_exc()
        "
        
    - name: Test token refresh logic
      run: |
        echo "Ki·ªÉm tra logic token refresh..."
        python -c "
        import sys
        import os
        
        # S·ª≠a ƒë∆∞·ªùng d·∫´n cho GitHub Actions
        sys.path.append('.')
        
        try:
            # Test TikTok Shop authenticator
            print('üîç Testing TikTok Shop authenticator...')
            from src.utils.auth import TikTokAuthenticator
            
            authenticator = TikTokAuthenticator()
            
            # Test token expiry check
            is_expired = authenticator.is_token_expired()
            print(f'‚úÖ Token expiry check: {\"Expired\" if is_expired else \"Valid\"}')
            
            # Test refresh token expiry check
            is_refresh_expired = authenticator.is_refresh_token_expired()
            print(f'‚úÖ Refresh token expiry check: {\"Expired\" if is_refresh_expired else \"Valid\"}')
            
            # Test signature generation
            try:
                test_params = {
                    'app_key': 'test_key',
                    'timestamp': '1234567890',
                    'shop_cipher': 'test_cipher'
                }
                signature = authenticator.generate_signature('/test/endpoint', test_params)
                if signature:
                    print('‚úÖ Signature generation successful')
                else:
                    print('‚ö†Ô∏è Signature generation failed')
            except Exception as e:
                print(f'‚ö†Ô∏è Signature generation test failed: {str(e)}')
            
            # Test ensure_valid_token method
            try:
                is_valid = authenticator.ensure_valid_token()
                print(f'‚úÖ Token validation: {\"Valid\" if is_valid else \"Invalid\"}')
            except Exception as e:
                print(f'‚ö†Ô∏è Token validation test failed: {str(e)}')
                
        except Exception as e:
            print(f'‚ùå L·ªói test token refresh: {e}')
            import traceback
            traceback.print_exc()
        "

  # Job 2: Build Docker Image
  build-docker:
    needs: test-dags
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      run: |
        echo "Building Docker image cho ETL pipeline..."
        docker build -t facolos-etl-pipeline:latest .
        
    - name: Test Docker image
      run: |
        echo "Testing Docker image..."
        docker run --rm facolos-etl-pipeline:latest python -c "
        import sys
        
        # S·ª≠a ƒë∆∞·ªùng d·∫´n cho Docker container
        sys.path.append('/opt/airflow/')
        print('‚úÖ Docker image test th√†nh c√¥ng')
        "

  # Job 3: Deploy to Ubuntu VM
  deploy-to-vm:
    needs: [test-dags, build-docker]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH key
      env:
        SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_ETL_FACOLOS_SECRET }}
      run: |
        echo "Setting up SSH key..."
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/id_rsa
        ssh-keyscan -p 22 -H ${{ env.VM_HOST }} >> ~/.ssh/known_hosts || true
        
    - name: Test SSH connection
      run: |
        echo "Testing SSH connection to VM..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.VM_USER }}@${{ env.VM_HOST }} "echo 'SSH connection successful'"
        
    - name: Deploy to VM
      run: |
        echo "Deploying ETL pipeline to Ubuntu VM..."
        
        # T·∫°o th∆∞ m·ª•c deploy tr√™n VM
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.VM_USER }}@${{ env.VM_HOST }} "
          mkdir -p /home/${{ env.VM_USER }}/facolos-data-pipelines
          cd /home/${{ env.VM_USER }}/facolos-data-pipelines
          
          # Backup current deployment n·∫øu c√≥
          if [ -d '.git' ]; then
            echo 'Backing up current deployment...'
            git stash
          fi
        "
        
        # Copy code l√™n VM
        rsync -avz --delete -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
          --exclude='.git' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          ./ ${{ env.VM_USER }}@${{ env.VM_HOST }}:/home/${{ env.VM_USER }}/facolos-data-pipelines/
          
    - name: Setup environment tr√™n VM
      run: |
        echo "Setting up environment tr√™n VM..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.VM_USER }}@${{ env.VM_HOST }} "
          cd /home/${{ env.VM_USER }}/facolos-data-pipelines
          
          # Ki·ªÉm tra Docker v√† Docker Compose
          if ! command -v docker &> /dev/null; then
            echo 'Docker ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t'
            exit 1
          fi
          
          if ! docker compose version &> /dev/null; then
            echo 'Docker Compose ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t'
            exit 1
          fi
          
          echo 'Docker v√† Docker Compose ƒë√£ s·∫µn s√†ng'
        "
        
    - name: Force rebuild SQL Server
      run: |
        echo "Force rebuilding SQL Server ƒë·ªÉ c·∫≠p nh·∫≠t schema..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.VM_USER }}@${{ env.VM_HOST }} "
          cd /home/${{ env.VM_USER }}/facolos-data-pipelines
          
          # Stop existing containers
          echo 'Stopping existing containers...'
          docker compose down || true
          
          # Force remove SQL Server volume ƒë·ªÉ ƒë·∫£m b·∫£o schema m·ªõi
          echo 'Removing SQL Server volume ƒë·ªÉ force schema update...'
          docker volume rm facolos-data-pipelines_sqlserver_data || true
          
          # Build SQL Server container v·ªõi no-cache
          echo 'Building SQL Server container v·ªõi no-cache...'
          docker compose build --no-cache sqlserver
          
          # Start SQL Server tr∆∞·ªõc ƒë·ªÉ ƒë·∫£m b·∫£o schema ƒë∆∞·ª£c t·∫°o
          echo 'Starting SQL Server container...'
          docker compose up -d sqlserver
          
          # Wait for SQL Server to be ready
          echo 'Waiting for SQL Server to be ready...'
          sleep 30
        "
        
    - name: Deploy v·ªõi Docker Compose
      run: |
        echo "Deploying v·ªõi Docker Compose..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.VM_USER }}@${{ env.VM_HOST }} "
          cd /home/${{ env.VM_USER }}/facolos-data-pipelines
          
          # Build remaining containers
          echo 'Building remaining containers...'
          docker compose build --no-cache
          
          # Start all containers
          echo 'Starting all containers...'
          docker compose up -d
          
          # Wait for services to be ready
          echo 'Waiting for services to be ready...'
          sleep 30
          
          # Check container status
          echo 'Checking container status...'
          docker compose ps
          
          # Check Airflow webserver health
          echo 'Checking Airflow webserver health...'
          curl -f http://localhost:8080/health || echo 'Airflow webserver ch∆∞a s·∫µn s√†ng'
        "
        
    - name: Verify deployment
      run: |
        echo "Verifying deployment..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.VM_USER }}@${{ env.VM_HOST }} "
          cd /home/${{ env.VM_USER }}/facolos-data-pipelines
          
          # Check if all containers are running
          echo 'Container status:'
          docker compose ps
          
          # Wait for Airflow to be ready
          echo 'Waiting for Airflow to be ready...'
          sleep 60
          
          # Check Airflow webserver health
          echo 'Checking Airflow webserver health...'
          curl -f http://localhost:8080/health || echo 'Airflow webserver ch∆∞a s·∫µn s√†ng'
          
          # Check Airflow DAGs
          echo 'Checking Airflow DAGs...'
          docker compose exec -T airflow-webserver airflow dags list || echo 'Kh√¥ng th·ªÉ list DAGs'
          
          # Check database connections
          echo 'Checking database connections...'
          docker compose exec -T airflow-webserver airflow connections list || echo 'Kh√¥ng th·ªÉ list connections'
          
          # Verify SQL Server schema ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t
          echo 'Verifying SQL Server schema...'
          docker compose exec -T sqlserver /opt/mssql-tools18/bin/sqlcmd \
            -S localhost -U sa -P \"${SQL_SERVER_PASSWORD}\" \
            -Q \"SELECT COLUMN_NAME, DATA_TYPE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'tiktok_shop_order_detail' AND COLUMN_NAME IN ('create_time', 'update_time', 'paid_time') ORDER BY COLUMN_NAME;\" \
            -C -N || echo 'Kh√¥ng th·ªÉ verify schema'
          
          # Check logs for any errors
          echo 'Checking recent logs...'
          docker compose logs --tail=50 airflow-webserver
        "
        
    - name: Cleanup SSH key
      if: always()
      run: |
        echo "Cleaning up SSH key..."
        rm -f ~/.ssh/id_rsa

  # Job 4: Notification
  notify:
    needs: [deploy-to-vm]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify deployment status
      run: |
        if [ "${{ needs.deploy-to-vm.result }}" == "success" ]; then
          echo "‚úÖ Deployment th√†nh c√¥ng!"
          echo "ETL Pipeline ƒë√£ ƒë∆∞·ª£c deploy l√™n VM Ubuntu"
          echo "Airflow Webserver: http://${{ env.VM_HOST }}:8080"
        else
          echo "‚ùå Deployment th·∫•t b·∫°i!"
          echo "Vui l√≤ng ki·ªÉm tra logs ƒë·ªÉ xem l·ªói"
        fi
