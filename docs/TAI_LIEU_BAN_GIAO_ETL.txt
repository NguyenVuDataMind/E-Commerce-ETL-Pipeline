TÀI LIỆU BÀN GIAO DỰ ÁN ETL: facolos-data-pipelines

1) MỤC TIÊU VÀ PHẠM VI
- Mục tiêu: Tự động hoá quy trình ETL (Extract-Transform-Load) từ TikTok Shop, Shopee và MISA CRM vào SQL Server (staging) để phục vụ báo cáo và các nhu cầu vận hành.
- Phạm vi hiện tại:
  • TikTok Shop: mô hình bảng phẳng theo từng line item của đơn hàng.
  • Shopee: mô hình 6 bảng staging (đơn hàng và các bảng liên quan).
  • MISA CRM: nhiều endpoint (customers, sale_orders, contacts, stocks, products) chuyển đổi theo cấu trúc phẳng có tiền tố cột cho sale_orders còn 4 endpoint khác không làm phẳng.
- Điều phối: Airflow DAGs (full load lịch sử và incremental mỗi 15p một lần).

2) THIẾT LẬP VÀ XÁC THỰC
- Biến môi trường (.env): quản lý toàn bộ thông tin nhạy cảm (DB, TikTok Shop, Shopee, MISA CRM). Không lưu khoá bí mật trong mã nguồn.
- Lưu trữ token: Bảng điều khiển etl_control.api_token_storage trên SQL Server lưu access_token/refresh_token/expires_at cho từng nền tảng (platform = 'tiktok_shop'|'shopee'|'misa_crm').
- Tự động làm mới token: Khi token hết hạn/hết hạn sớm sẽ tự refresh và cập nhật lại DB (UPSERT). Có fallback đọc từ biến môi trường khi DB chưa sẵn sàng.

3) CHÍNH SÁCH THỜI GIAN VÀ MÚI GIỜ
- Trong quá trình extract/transform: chuẩn hoá tất cả thời gian về UTC (tz-aware) để so sánh, lọc incremental chính xác.
- Khi load vào SQL Server: chuyển các cột thời gian sang Asia/Ho_Chi_Minh (+07) và lưu dạng DATETIME2 tz-naive để đồng bộ quy ước nội bộ.
- Metadata ETL: etl_created_at, etl_updated_at ghi theo giờ Việt Nam (+07); khi upsert, etl_updated_at được cập nhật tự động theo giờ VN.

4) SHOPEE — MÔ HÌNH 6 BẢNG VÀ ÁNH XẠ CỤ THỂ
4.1 Danh sách 6 bảng staging (schema staging)
- shopee_orders
- shopee_recipient_address
- shopee_order_items
- shopee_order_item_locations
- shopee_packages
- shopee_package_items

4.2 Bảng shopee_orders (PK: order_sn)
- order.order_sn -> order_sn (NVARCHAR(50))
- order.region -> region (NVARCHAR(10))
- order.currency -> currency (NVARCHAR(10))
- order.cod -> cod (BIT)
- order.total_amount -> total_amount (DECIMAL(18,4))
- order.order_status -> order_status (NVARCHAR(50))
- order.shipping_carrier -> shipping_carrier (NVARCHAR(100))
- order.payment_method -> payment_method (NVARCHAR(100))
- order.estimated_shipping_fee -> estimated_shipping_fee (DECIMAL(18,4))
- order.message_to_seller -> message_to_seller (NVARCHAR(MAX))
- order.create_time (epoch giây) -> create_time (DATETIME2 +07)
- order.update_time (epoch giây) -> update_time (DATETIME2 +07)
- order.days_to_ship -> days_to_ship (INT)
- order.ship_by_date (epoch giây) -> ship_by_date (DATETIME2 +07)
- order.buyer_user_id -> buyer_user_id (BIGINT)
- order.buyer_username -> buyer_username (NVARCHAR(100))
- order.actual_shipping_fee -> actual_shipping_fee (DECIMAL(18,4))
- order.actual_shipping_fee_confirmed -> actual_shipping_fee_confirmed (BIT)
- order.goods_to_declare -> goods_to_declare (BIT)
- order.note -> note (NVARCHAR(MAX))
- order.note_update_time (epoch giây) -> note_update_time (DATETIME2 +07)
- order.pay_time (epoch giây) -> pay_time (DATETIME2 +07)
- order.dropshipper -> dropshipper (NVARCHAR(100))
- order.dropshipper_phone -> dropshipper_phone (NVARCHAR(50))
- order.split_up -> split_up (BIT)
- order.buyer_cancel_reason -> buyer_cancel_reason (NVARCHAR(MAX))
- order.cancel_by -> cancel_by (NVARCHAR(100))
- order.cancel_reason -> cancel_reason (NVARCHAR(MAX))
- order.buyer_cpf_id -> buyer_cpf_id (NVARCHAR(50))
- order.fulfillment_flag -> fulfillment_flag (NVARCHAR(50))
- order.pickup_done_time (epoch giây) -> pickup_done_time (DATETIME2 +07)
- order.reverse_shipping_fee -> reverse_shipping_fee (DECIMAL(18,4))
- order.order_chargeable_weight_gram -> order_chargeable_weight_gram (INT)
- order.edt_from (epoch giây) -> edt_from (DATETIME2 +07)
- order.edt_to (epoch giây) -> edt_to (DATETIME2 +07)
- order.booking_sn -> booking_sn (NVARCHAR(50))
- order.advance_package -> advance_package (BIT)
- order.return_request_due_date (epoch giây) -> return_request_due_date (DATETIME2 +07)
- order.is_buyer_shop_collection -> is_buyer_shop_collection (BIT)
- order.hot_listing_order -> hot_listing_order (BIT)
- (internal) -> source_request_id (NVARCHAR(100))
- (internal, default +07) -> ingested_at (DATETIME2)
- ETL: (internal) -> etl_batch_id (NVARCHAR(50)), etl_created_at (DATETIME2 +07), etl_updated_at (DATETIME2 +07), etl_source (NVARCHAR(50), 'shopee_api')

4.3 Bảng shopee_recipient_address (PK/FK: order_sn)
- order.order_sn -> order_sn (NVARCHAR(50))
- order.recipient_address.name -> name (NVARCHAR(200))
- order.recipient_address.phone -> phone (NVARCHAR(50))
- order.recipient_address.town -> town (NVARCHAR(100))
- order.recipient_address.district -> district (NVARCHAR(100))
- order.recipient_address.city -> city (NVARCHAR(100))
- order.recipient_address.state -> state (NVARCHAR(100))
- order.recipient_address.region -> region (NVARCHAR(100))
- order.recipient_address.zipcode -> zipcode (NVARCHAR(20))
- order.recipient_address.full_address -> full_address (NVARCHAR(MAX))
- (internal) -> source_request_id (NVARCHAR(100))
- (internal, default +07) -> ingested_at (DATETIME2)
- ETL: (internal) -> etl_batch_id (NVARCHAR(50)), etl_created_at (DATETIME2 +07), etl_updated_at (DATETIME2 +07), etl_source (NVARCHAR(50))

4.4 Bảng shopee_order_items (PK: order_sn, order_item_id, model_id)
- order.order_sn -> order_sn (NVARCHAR(50))
- item.order_item_id -> order_item_id (BIGINT)
- item.item_id -> item_id (BIGINT)
- item.item_name -> item_name (NVARCHAR(500))
- item.item_sku -> item_sku (NVARCHAR(100))
- item.model_id -> model_id (BIGINT)
- item.model_name -> model_name (NVARCHAR(500))
- item.model_sku -> model_sku (NVARCHAR(100))
- item.model_quantity_purchased -> model_quantity_purchased (INT)
- item.model_original_price -> model_original_price (DECIMAL(18,4))
- item.model_discounted_price -> model_discounted_price (DECIMAL(18,4))
- item.wholesale -> wholesale (BIT)
- item.weight -> weight (DECIMAL(18,4))
- item.add_on_deal -> add_on_deal (BIT)
- item.main_item -> main_item (BIT)
- item.add_on_deal_id -> add_on_deal_id (BIGINT)
- item.promotion_type -> promotion_type (NVARCHAR(50))
- item.promotion_id -> promotion_id (BIGINT)
- item.promotion_group_id -> promotion_group_id (BIGINT)
- item.is_prescription_item -> is_prescription_item (BIT)
- item.is_b2c_owned_item -> is_b2c_owned_item (BIT)
- item.consultation_id -> consultation_id (NVARCHAR(100))
- item.image_info.image_url -> image_url (NVARCHAR(MAX))
- item.hot_listing_item -> hot_listing_item (BIT)
- (internal) -> source_request_id (NVARCHAR(100))
- (internal, default +07) -> ingested_at (DATETIME2)
- ETL: (internal) -> etl_batch_id (NVARCHAR(50)), etl_created_at (DATETIME2 +07), etl_updated_at (DATETIME2 +07), etl_source (NVARCHAR(50))

4.5 Bảng shopee_order_item_locations (PK: order_sn, order_item_id, model_id, location_id)
- order.order_sn -> order_sn (NVARCHAR(50))
- item.order_item_id -> order_item_id (BIGINT)
- item.model_id -> model_id (BIGINT)
- item.product_location_id -> location_id (NVARCHAR(100))
- (internal) -> source_request_id (NVARCHAR(100))
- (internal, default +07) -> ingested_at (DATETIME2)
- ETL: (internal) -> etl_batch_id (NVARCHAR(50)), etl_created_at (DATETIME2 +07), etl_updated_at (DATETIME2 +07), etl_source (NVARCHAR(50))

4.6 Bảng shopee_packages (PK: order_sn, package_number)
- order.order_sn -> order_sn (NVARCHAR(50))
- package.package_number -> package_number (NVARCHAR(100))
- package.logistics_status -> logistics_status (NVARCHAR(50))
- package.logistics_channel_id -> logistics_channel_id (BIGINT)
- package.shipping_carrier -> shipping_carrier (NVARCHAR(100))
- package.allow_self_design_awb -> allow_self_design_awb (BIT)
- package.parcel_chargeable_weight_gram -> parcel_chargeable_weight_gram (INT)
- package.group_shipment_id -> group_shipment_id (BIGINT)
- package.sorting_group -> sorting_group (NVARCHAR(100))
- (internal) -> source_request_id (NVARCHAR(100))
- (internal, default +07) -> ingested_at (DATETIME2)
- ETL: (internal) -> etl_batch_id (NVARCHAR(50)), etl_created_at (DATETIME2 +07), etl_updated_at (DATETIME2 +07), etl_source (NVARCHAR(50))

4.7 Bảng shopee_package_items (PK: order_sn, package_number, order_item_id, model_id)
- order.order_sn -> order_sn (NVARCHAR(50))
- package.package_number -> package_number (NVARCHAR(100))
- pkg_item.order_item_id -> order_item_id (BIGINT)
- pkg_item.item_id -> item_id (BIGINT)
- pkg_item.model_id -> model_id (BIGINT)
- pkg_item.model_quantity -> model_quantity (INT)
- pkg_item.promotion_group_id -> promotion_group_id (BIGINT)
- pkg_item.product_location_id -> product_location_id (NVARCHAR(100))
- pkg_item.parcel_chargeable_weight -> parcel_chargeable_weight (INT)
- (internal) -> source_request_id (NVARCHAR(100))
- (internal, default +07) -> ingested_at (DATETIME2)
- ETL: (internal) -> etl_batch_id (NVARCHAR(50)), etl_created_at (DATETIME2 +07), etl_updated_at (DATETIME2 +07), etl_source (NVARCHAR(50))

4.8 Múi giờ Shopee
- Tất cả timestamp epoch → chuyển UTC trong transform → lưu +07-naive khi load để đồng bộ báo cáo nội bộ.

4.9 Upsert Shopee
- Upsert theo khoá tự nhiên từng bảng.
- Guard cập nhật: cập nhật khi update_time có bản ghi mới hơn; riêng bảng orders bổ sung cập nhật khi order_status thay đổi.
- Batch-size tối ưu để không vượt giới hạn tham số SQL Server; làm sạch NaN/NaT/chuỗi rỗng → NULL trước khi bind.

5) TIKTOK SHOP — BẢNG PHẲNG VÀ ÁNH XẠ CỤ THỂ
5.1 Bảng staging phẳng (mỗi dòng là một line item; PK upsert: order_id, item_id)
A. Nhóm trường cấp đơn hàng
- order.id -> order_id (NVARCHAR(100))
- order.status -> order_status (NVARCHAR(100))
- order.buyer_email -> buyer_email (NVARCHAR(500))
- order.buyer_message -> buyer_message (NVARCHAR(MAX))
- order.create_time (epoch giây) -> create_time (DATETIME2 +07)
- order.update_time (epoch giây) -> update_time (DATETIME2 +07)
- order.fulfillment_type -> fulfillment_type (NVARCHAR(100))
- order.payment_method_name -> payment_method_name (NVARCHAR(200))
- order.warehouse_id -> warehouse_id (NVARCHAR(100))
- order.user_id -> user_id (NVARCHAR(100))
- order.request_id -> request_id (NVARCHAR(200))
- order.shop_id -> shop_id (NVARCHAR(100))
- order.region -> region (NVARCHAR(50))
- order.cancel_order_sla_time (epoch giây) -> cancel_order_sla_time (DATETIME2 +07)
- order.collection_due_time (epoch giây) -> collection_due_time (DATETIME2 +07)
- order.commerce_platform -> commerce_platform (NVARCHAR(100))
- order.delivery_option_id -> delivery_option_id (NVARCHAR(100))
- order.delivery_option_name -> delivery_option_name (NVARCHAR(200))
- order.delivery_type -> delivery_type (NVARCHAR(100))
- order.fulfillment_priority_level -> fulfillment_priority_level (INT)
- order.has_updated_recipient_address -> has_updated_recipient_address (BIT)
- order.is_cod -> is_cod (BIT)
- order.is_on_hold_order -> is_on_hold_order (BIT)
- order.is_replacement_order -> is_replacement_order (BIT)
- order.is_sample_order -> is_sample_order (BIT)
- order.order_type -> order_type (NVARCHAR(100))
- order.paid_time (epoch giây) -> paid_time (DATETIME2 +07)
- order.recommended_shipping_time (epoch ms/giây) -> recommended_shipping_time (DATETIME2 +07)
- order.rts_sla_time (epoch giây) -> rts_sla_time (DATETIME2 +07)
- order.shipping_due_time (epoch giây) -> shipping_due_time (DATETIME2 +07)
- order.shipping_provider -> shipping_provider (NVARCHAR(200))
- order.shipping_provider_id -> shipping_provider_id (NVARCHAR(100))
- order.shipping_type -> shipping_type (NVARCHAR(100))
- order.tts_sla_time (epoch giây) -> tts_sla_time (DATETIME2 +07)
- order.tracking_number -> tracking_number (NVARCHAR(200))
- order.is_buyer_request_cancel -> is_buyer_request_cancel (BIT)
- order.cancel_reason -> cancel_reason (NVARCHAR(MAX))
- order.split_or_combine_tag -> split_or_combine_tag (NVARCHAR(100))
- order.rts_time (epoch giây) -> rts_time (DATETIME2 +07)
- order.packages[0].id -> package_id (NVARCHAR(50))
- JSON.stringify(order.payment) -> payment_info_json (NVARCHAR(MAX))
- JSON.stringify(order.line_items) -> line_items_json (NVARCHAR(MAX))
- JSON.stringify(order.packages) -> packages_json (NVARCHAR(MAX))
- JSON.stringify(order) -> raw_order_json (NVARCHAR(MAX))

B. Nhóm thanh toán (map từ object payment)
- payment.currency -> payment_currency (NVARCHAR(10))
- payment.original_shipping_fee -> payment_original_shipping_fee (DECIMAL(18,4))
- payment.original_total_product_price -> payment_original_total_product_price (DECIMAL(18,4))
- payment.platform_discount -> payment_platform_discount (DECIMAL(18,4))
- payment.seller_discount -> payment_seller_discount (DECIMAL(18,4))
- payment.shipping_fee -> payment_shipping_fee (DECIMAL(18,4))
- payment.shipping_fee_cofunded_discount -> payment_shipping_fee_cofunded_discount (DECIMAL(18,4))
- payment.shipping_fee_platform_discount -> payment_shipping_fee_platform_discount (DECIMAL(18,4))
- payment.shipping_fee_seller_discount -> payment_shipping_fee_seller_discount (DECIMAL(18,4))
- payment.sub_total -> payment_sub_total (DECIMAL(18,4))
- payment.tax -> payment_tax (DECIMAL(18,4))
- payment.total_amount -> payment_total_amount (DECIMAL(18,4))

C. Nhóm địa chỉ người nhận
- recipient_address.address_detail -> recipient_address_detail (NVARCHAR(500))
- recipient_address.address_line1 -> recipient_address_line1 (NVARCHAR(500))
- recipient_address.address_line2 -> recipient_address_line2 (NVARCHAR(500))
- recipient_address.address_line3 -> recipient_address_line3 (NVARCHAR(500))
- recipient_address.address_line4 -> recipient_address_line4 (NVARCHAR(500))
- recipient_address.first_name -> recipient_first_name (NVARCHAR(100))
- recipient_address.first_name_local_script -> recipient_first_name_local_script (NVARCHAR(100))
- recipient_address.last_name -> recipient_last_name (NVARCHAR(100))
- recipient_address.last_name_local_script -> recipient_last_name_local_script (NVARCHAR(100))
- recipient_address.name -> recipient_name (NVARCHAR(200))
- recipient_address.full_address -> recipient_full_address (NVARCHAR(MAX))
- recipient_address.phone_number -> recipient_phone_number (NVARCHAR(100))
- recipient_address.postal_code -> recipient_postal_code (NVARCHAR(50))
- recipient_address.region_code -> recipient_region_code (NVARCHAR(50))
- JSON.stringify(recipient_address.district_info) -> recipient_district_info (NVARCHAR(MAX))
- JSON.stringify(recipient_address) -> recipient_address_json (NVARCHAR(MAX))

D. Nhóm line item (mỗi item → 1 dòng)
- item.id -> item_id (NVARCHAR(100))
- item.product_id -> item_product_id (NVARCHAR(100))
- item.product_name -> item_product_name (NVARCHAR(1000))
- item.sku_id -> item_sku_id (NVARCHAR(100))
- item.sku_name -> item_sku_name (NVARCHAR(1000))
- item.sku_type -> item_sku_type (NVARCHAR(100))
- item.sku_image -> item_sku_image (NVARCHAR(MAX))
- item.seller_sku -> item_seller_sku (NVARCHAR(200))
- item.quantity -> item_quantity (INT)
- item.currency -> item_currency (NVARCHAR(10))
- item.display_status -> item_display_status (NVARCHAR(100))
- item.is_gift -> item_is_gift (BIT)
- item.original_price -> item_original_price (DECIMAL(18,4))
- item.sale_price -> item_sale_price (DECIMAL(18,4))
- item.platform_discount -> item_platform_discount (DECIMAL(18,4))
- item.seller_discount -> item_seller_discount (DECIMAL(18,4))
- item.package_id -> item_package_id (NVARCHAR(50))
- item.package_status -> item_package_status (NVARCHAR(100))
- item.shipping_provider_id -> item_shipping_provider_id (NVARCHAR(100))
- item.shipping_provider_name -> item_shipping_provider_name (NVARCHAR(200))
- item.tracking_number -> item_tracking_number (NVARCHAR(200))
- item.cancel_reason -> item_cancel_reason (NVARCHAR(MAX))
- item.rts_time (epoch giây) -> item_rts_time (DATETIME2 +07)
- JSON.stringify(item) -> item_sku_attributes (NVARCHAR(MAX))

E. Metadata ETL
- (internal) -> etl_batch_id (NVARCHAR(50)), etl_created_at (DATETIME2 +07), etl_updated_at (DATETIME2 +07), etl_source (NVARCHAR(50), 'tiktok_shop_api')

5.2 Múi giờ TikTok Shop
- Epoch → UTC tz-aware trong transform → lưu +07-naive (DATETIME2) khi load.

5.3 Upsert TikTok Shop
- Khóa: (order_id, item_id).
- Guard cập nhật: ưu tiên update_time mới hơn; đồng thời cập nhật khi order_status/ tracking_number/ shipping_provider thay đổi.
- Làm sạch dữ liệu trước khi bind, chia batch nhỏ để không vượt giới hạn tham số SQL Server.

6) MISA CRM — NGUYÊN TẮC ÁNH XẠ
- Phương pháp: giữ nguyên tên trường API theo hai nhóm, làm phẳng dữ liệu cho endpoint sale_orders:
  • Nhóm trường cấp order có tiền tố "order_" (ví dụ: order_sale_order_date, order_total_summary,...).
  • Nhóm trường cấp item (sale_order_product_mappings) có tiền tố "item_" (ví dụ: item_price, item_quantity_ordered,...).
- Thời gian: chuẩn hoá UTC trong transform, lưu +07-naive khi load.
- Các endpoint (customers, contacts, stocks, products): mapping 1–1 theo tên trường API; thêm etl_* theo batch.

6.1 MISA Customers — Ánh xạ json_path -> cột (kiểu)
- id -> id (BIGINT)
- account_number -> account_number (NVARCHAR(50))
- account_name -> account_name (NVARCHAR(500))
- account_short_name -> account_short_name (NVARCHAR(255))
- owner_name -> owner_name (NVARCHAR(255))
- office_tel -> office_tel (NVARCHAR(50))
- office_email -> office_email (NVARCHAR(255))
- website -> website (NVARCHAR(500))
- fax -> fax (NVARCHAR(50))
- billing_address -> billing_address (NVARCHAR(MAX))
- billing_country -> billing_country (NVARCHAR(100))
- billing_province -> billing_province (NVARCHAR(100))
- billing_district -> billing_district (NVARCHAR(100))
- billing_ward -> billing_ward (NVARCHAR(100))
- billing_street -> billing_street (NVARCHAR(255))
- billing_code -> billing_code (NVARCHAR(20))
- shipping_address -> shipping_address (NVARCHAR(MAX))
- shipping_country -> shipping_country (NVARCHAR(100))
- shipping_province -> shipping_province (NVARCHAR(100))
- shipping_district -> shipping_district (NVARCHAR(100))
- shipping_ward -> shipping_ward (NVARCHAR(100))
- shipping_street -> shipping_street (NVARCHAR(255))
- shipping_code -> shipping_code (NVARCHAR(20))
- business_type -> business_type (NVARCHAR(100))
- industry -> industry (NVARCHAR(100))
- annual_revenue -> annual_revenue (DECIMAL(15,2))
- tax_code -> tax_code (NVARCHAR(50))
- bank_account -> bank_account (NVARCHAR(100))
- bank_name -> bank_name (NVARCHAR(255))
- debt -> debt (DECIMAL(15,2))
- debt_limit -> debt_limit (DECIMAL(15,2))
- number_of_days_owed -> number_of_days_owed (DECIMAL(10,2))
- number_orders -> number_orders (DECIMAL(10,2))
- order_sales -> order_sales (DECIMAL(15,2))
- average_order_value -> average_order_value (DECIMAL(15,2))
- average_number_of_days_between_purchases -> average_number_of_days_between_purchases (DECIMAL(10,2))
- number_days_without_purchase -> number_days_without_purchase (DECIMAL(10,2))
- list_product_category -> list_product_category (NVARCHAR(MAX))
- list_product_name -> list_product (NVARCHAR(MAX))
- purchase_date_recent -> purchase_date_recent (DATETIME2)
- purchase_date_first -> purchase_date_first (DATETIME2)
- customer_since_date -> customer_since_date (DATETIME2)
- last_interaction_date -> last_interaction_date (DATETIME2)
- last_visit_date -> last_visit_date (DATETIME2)
- last_call_date -> last_call_date (DATETIME2)
- issued_on -> issued_on (DATETIME2)
- celebrate_date -> celebrate_date (DATETIME2)
- created_date -> created_date (DATETIME2)
- modified_date -> modified_date (DATETIME2)
- last_modified_date -> last_modified_date (DATETIME2)
- is_personal -> is_personal (BIT)
- inactive -> inactive (BIT)
- is_public -> is_public (BIT)
- is_distributor -> is_distributor (BIT)
- is_portal_access -> is_portal_access (BIT)
- portal_username -> portal_username (NVARCHAR(100))
- gender -> gender (NVARCHAR(20))
- identification -> identification (NVARCHAR(50))
- place_of_issue -> place_of_issue (NVARCHAR(255))
- organization_unit_name -> organization_unit_name (NVARCHAR(255))
- form_layout -> form_layout (NVARCHAR(100))
- rating -> rating (NVARCHAR(50))
- lead_source -> lead_source (NVARCHAR(100))
- sector_name -> sector_name (NVARCHAR(100))
- no_of_employee_name -> no_of_employee_name (NVARCHAR(100))
- parent_account_name -> parent_account_name (NVARCHAR(255))
- budget_code -> budget_code (NVARCHAR(50))
- total_score -> total_score (DECIMAL(10,2))
- number_days_not_interacted -> number_days_not_interacted (NVARCHAR(50))
- related_users -> related_users (NVARCHAR(MAX))
- description -> description (NVARCHAR(MAX))
- tag -> tag (NVARCHAR(MAX))
- created_by -> created_by (NVARCHAR(255))
- modified_by -> modified_by (NVARCHAR(255))
- shipping_long -> shipping_long (DECIMAL(10,7))
- shipping_lat -> shipping_lat (DECIMAL(10,7))
- billing_long -> billing_long (DECIMAL(10,7))
- billing_lat -> billing_lat (DECIMAL(10,7))
- custom_field13 -> custom_field13 (NVARCHAR(MAX))
- custom_field14 -> custom_field14 (NVARCHAR(MAX))

6.2 MISA Contacts — Ánh xạ json_path -> cột (kiểu)
- id -> id (BIGINT)
- contact_code -> contact_code (NVARCHAR(50))
- account_code -> account_code (NVARCHAR(50))
- contact_name -> contact_name (NVARCHAR(255))
- first_name -> first_name (NVARCHAR(100))
- last_name -> last_name (NVARCHAR(100))
- salutation -> salutation (NVARCHAR(20))
- mobile -> mobile (NVARCHAR(50))
- office_tel -> office_tel (NVARCHAR(50))
- other_phone -> other_phone (NVARCHAR(50))
- office_email -> office_email (NVARCHAR(255))
- email -> email (NVARCHAR(255))
- facebook -> facebook (NVARCHAR(255))
- zalo -> zalo (NVARCHAR(100))
- account_name -> account_name (NVARCHAR(500))
- title -> title (NVARCHAR(100))
- department -> department (NVARCHAR(100))
- account_type -> account_type (NVARCHAR(100))
- mailing_address -> mailing_address (NVARCHAR(MAX))
- mailing_country -> mailing_country (NVARCHAR(100))
- mailing_province -> mailing_province (NVARCHAR(100))
- mailing_district -> mailing_district (NVARCHAR(100))
- mailing_ward -> mailing_ward (NVARCHAR(100))
- mailing_street -> mailing_street (NVARCHAR(255))
- mailing_zip -> mailing_zip (NVARCHAR(20))
- shipping_address -> shipping_address (NVARCHAR(MAX))
- shipping_country -> shipping_country (NVARCHAR(100))
- shipping_province -> shipping_province (NVARCHAR(100))
- shipping_district -> shipping_district (NVARCHAR(100))
- shipping_ward -> shipping_ward (NVARCHAR(100))
- shipping_street -> shipping_street (NVARCHAR(255))
- shipping_zip -> shipping_zip (NVARCHAR(20))
- mailing_long -> mailing_long (DECIMAL(10,7))
- mailing_lat -> mailing_lat (DECIMAL(10,7))
- shipping_long -> shipping_long (DECIMAL(10,7))
- shipping_lat -> shipping_lat (DECIMAL(10,7))
- date_of_birth -> date_of_birth (DATETIME2)
- gender -> gender (NVARCHAR(20))
- married_status -> married_status (NVARCHAR(50))
- bank_account -> bank_account (NVARCHAR(100))
- bank_name -> bank_name (NVARCHAR(255))
- email_opt_out -> email_opt_out (BIT)
- phone_opt_out -> phone_opt_out (BIT)
- lead_source -> lead_source (NVARCHAR(100))
- customer_since_date -> customer_since_date (DATETIME2)
- organization_unit_name -> organization_unit_name (NVARCHAR(255))
- owner_name -> owner_name (NVARCHAR(255))
- form_layout -> form_layout (NVARCHAR(100))
- inactive -> inactive (BIT)
- total_score -> total_score (DECIMAL(10,2))
- last_interaction_date -> last_interaction_date (DATETIME2)
- last_visit_date -> last_visit_date (DATETIME2)
- last_call_date -> last_call_date (DATETIME2)
- number_days_not_interacted -> number_days_not_interacted (DECIMAL(10,2))
- is_public -> is_public (BIT)
- tag -> tag (NVARCHAR(MAX))
- related_users -> related_users (NVARCHAR(MAX))
- description -> description (NVARCHAR(MAX))
- created_date -> created_date (DATETIME2)
- created_by -> created_by (NVARCHAR(255))
- modified_date -> modified_date (DATETIME2)
- modified_by -> modified_by (NVARCHAR(255))

6.3 MISA Stocks — Ánh xạ json_path -> cột (kiểu)
- stock_code -> stock_code (NVARCHAR(50))
- act_database_id -> act_database_id (UNIQUEIDENTIFIER)
- async_id -> async_id (UNIQUEIDENTIFIER)
- stock_name -> stock_name (NVARCHAR(255))
- description -> description (NVARCHAR(MAX))
- inactive -> inactive (BIT)
- created_date -> created_date (DATETIME2)
- created_by -> created_by (NVARCHAR(255))
- modified_date -> modified_date (DATETIME2)
- modified_by -> modified_by (NVARCHAR(255))

6.4 MISA Products — Ánh xạ json_path -> cột (kiểu)
- id -> id (BIGINT)
- product_code -> product_code (NVARCHAR(50))
- product_name -> product_name (NVARCHAR(500))
- product_category -> product_category (NVARCHAR(100))
- usage_unit -> usage_unit (NVARCHAR(50))
- description -> description (NVARCHAR(MAX))
- sale_description -> sale_description (NVARCHAR(MAX))
- unit_price -> unit_price (DECIMAL(15,2))
- purchased_price -> purchased_price (DECIMAL(15,2))
- unit_cost -> unit_cost (DECIMAL(15,2))
- unit_price1 -> unit_price1 (DECIMAL(15,2))
- unit_price2 -> unit_price2 (DECIMAL(15,2))
- unit_price_fixed -> unit_price_fixed (DECIMAL(15,2))
- price_after_tax -> price_after_tax (BIT)
- tax -> tax (NVARCHAR(50))
- is_use_tax -> is_use_tax (BIT)
- product_properties -> product_properties (NVARCHAR(100))
- is_follow_serial_number -> is_follow_serial_number (BIT)
- is_set_product -> is_set_product (BIT)
- quantity_formula -> quantity_formula (NVARCHAR(MAX))
- default_stock -> default_stock (NVARCHAR(100))
- warranty_period -> warranty_period (NVARCHAR(100))
- warranty_description -> warranty_description (NVARCHAR(MAX))
- organization_unit_name -> organization_unit_name (NVARCHAR(255))
- owner_name -> owner_name (NVARCHAR(255))
- form_layout -> form_layout (NVARCHAR(100))
- source -> source (NVARCHAR(100))
- inactive -> inactive (BIT)
- is_public -> is_public (BIT)
- avatar -> avatar (NVARCHAR(MAX))
- tag -> tag (NVARCHAR(MAX))
- created_date -> created_date (DATETIME2)
- created_by -> created_by (NVARCHAR(255))
- modified_date -> modified_date (DATETIME2)
- modified_by -> modified_by (NVARCHAR(255))

6.5 MISA Sale Orders Flattened — Ánh xạ json_path -> cột (kiểu)
Nguyên tắc: 1-n (order ↔ items), dữ liệu đơn hàng phẳng hoá theo hai nhóm,1-n (order ↔ items) như vậy sẽ có những recored có trùng thông tin về phần order, nó sẽ khác ở phần item :
  • order.<field> -> order_<field> (kiểu theo schema)
  • sale_order_product_mappings[].<field> -> item_<field> (kiểu theo schema)

Nhóm order_* 
- id -> order_id (BIGINT)
- sale_order_no -> order_sale_order_no (NVARCHAR(50))
- account_name -> order_account_name (NVARCHAR(500))
- sale_order_name -> order_sale_order_name (NVARCHAR(MAX))
- sale_order_amount -> order_sale_order_amount (DECIMAL(15,2))
- sale_order_date -> order_sale_order_date (DATETIME2)
- due_date -> order_due_date (DATETIME2)
- status -> order_status (NVARCHAR(50))
- delivery_status -> order_delivery_status (NVARCHAR(50))
- pay_status -> order_pay_status (NVARCHAR(50))
- revenue_status -> order_revenue_status (NVARCHAR(50))
- total_summary -> order_total_summary (DECIMAL(15,2))
- tax_summary -> order_tax_summary (DECIMAL(15,2))
- discount_summary -> order_discount_summary (DECIMAL(15,2))
- to_currency_summary -> order_to_currency_summary (DECIMAL(15,2))
- total_receipted_amount -> order_total_receipted_amount (DECIMAL(15,2))
- balance_receipt_amount -> order_balance_receipt_amount (DECIMAL(15,2))
- invoiced_amount -> order_invoiced_amount (DECIMAL(15,2))
- un_invoiced_amount -> order_un_invoiced_amount (DECIMAL(15,2))
- currency_type -> order_currency_type (NVARCHAR(10))
- exchange_rate -> order_exchange_rate (DECIMAL(10,4))
- is_use_currency -> order_is_use_currency (BIT)
- billing_address -> order_billing_address (NVARCHAR(MAX))
- billing_country -> order_billing_country (NVARCHAR(100))
- billing_province -> order_billing_province (NVARCHAR(100))
- billing_district -> order_billing_district (NVARCHAR(100))
- billing_ward -> order_billing_ward (NVARCHAR(100))
- billing_street -> order_billing_street (NVARCHAR(255))
- billing_code -> order_billing_code (NVARCHAR(20))
- shipping_address -> order_shipping_address (NVARCHAR(MAX))
- shipping_country -> order_shipping_country (NVARCHAR(100))
- shipping_province -> order_shipping_province (NVARCHAR(100))
- shipping_district -> order_shipping_district (NVARCHAR(100))
- shipping_ward -> order_shipping_ward (NVARCHAR(100))
- shipping_street -> order_shipping_street (NVARCHAR(255))
- shipping_code -> order_shipping_code (NVARCHAR(20))
- phone -> order_phone (NVARCHAR(50))
- billing_contact -> order_billing_contact (NVARCHAR(255))
- shipping_contact_name -> order_shipping_contact_name (NVARCHAR(255))
- organization_unit_name -> order_organization_unit_name (NVARCHAR(255))
- owner_name -> order_owner_name (NVARCHAR(255))
- number_of_days_owed -> order_number_of_days_owed (DECIMAL(10,2))
- employee_code -> order_employee_code (NVARCHAR(50))
- account_code -> order_account_code (NVARCHAR(50))
- contact_code -> order_contact_code (NVARCHAR(50))
- book_date -> order_book_date (DATETIME2)
- deadline_date -> order_deadline_date (DATETIME2)
- delivery_date -> order_delivery_date (DATETIME2)
- paid_date -> order_paid_date (DATETIME2)
- invoice_date -> order_invoice_date (DATETIME2)
- production_date -> order_production_date (DATETIME2)
- created_date -> order_created_date (DATETIME2)
- modified_date -> order_modified_date (DATETIME2)
- approved_date -> order_approved_date (DATETIME2)
- campaign_name -> order_campaign_name (NVARCHAR(255))
- quote_name -> order_quote_name (NVARCHAR(255))
- opportunity_name -> order_opportunity_name (NVARCHAR(255))
- description -> order_description (NVARCHAR(MAX))
- billing_account -> order_billing_account (NVARCHAR(255))
- parent_name -> order_parent_name (NVARCHAR(255))
- recorded_sale_organization_unit_name -> order_recorded_sale_organization_unit_name (NVARCHAR(255))
- recorded_sale_users_name -> order_recorded_sale_users_name (NVARCHAR(255))
- created_by -> order_created_by (NVARCHAR(255))
- modified_by -> order_modified_by (NVARCHAR(255))
- tag -> order_tag (NVARCHAR(MAX))
- form_layout -> order_form_layout (NVARCHAR(100))
- promotion_applied -> order_promotion_applied (NVARCHAR(MAX))
- list_product -> order_list_product (NVARCHAR(MAX))
- list_product_category -> order_list_product_category (NVARCHAR(255))
- is_deleted -> order_is_deleted (BIT)
- is_public -> order_is_public (BIT)
- is_correct_route -> order_is_correct_route (BIT)
- is_visited -> order_is_visited (BIT)
- is_parent_sale_order -> order_is_parent_sale_order (BIT)
- is_invoiced -> order_is_invoiced (BIT)
- is_sync_price_after_discount -> order_is_sync_price_after_discount (BIT)
- production_confirmation_status -> order_production_confirmation_status (NVARCHAR(100))
- production_status -> order_production_status (NVARCHAR(100))
- production_rejection_reason -> order_production_rejection_reason (NVARCHAR(MAX))
- approved_status -> order_approved_status (NVARCHAR(100))
- approver -> order_approver (NVARCHAR(255))
- custom_field1Summary -> order_custom_field1Summary (DECIMAL(15,2))
- custom_field13 -> order_custom_field13 (NVARCHAR(MAX))
- custom_field1 -> order_custom_field1 (NVARCHAR(MAX))
- discount_overall -> order_discount_overall (DECIMAL(15,2))
- tax_overall -> order_tax_overall (DECIMAL(15,2))
- total_overall -> order_total_overall (DECIMAL(15,2))
- discount_overall_oc -> order_discount_overall_oc (DECIMAL(15,2))
- tax_overall_oc -> order_tax_overall_oc (DECIMAL(15,2))
- total_overall_oc -> order_total_overall_oc (DECIMAL(15,2))
- discount_percent_overall -> order_discount_percent_overall (DECIMAL(5,2))
- tax_percent_overall -> order_tax_percent_overall (DECIMAL(5,2))
- to_currency_after_discount_summary -> order_to_currency_after_discount_summary (DECIMAL(15,2))
- to_currency_oc_after_discount_summary -> order_to_currency_oc_after_discount_summary (DECIMAL(15,2))
- shipping_amount_summary -> order_shipping_amount_summary (DECIMAL(15,2))
- sale_order_process_cost -> order_sale_order_process_cost (DECIMAL(15,2))
- liquidate_amount -> order_liquidate_amount (DECIMAL(15,2))
- to_currency_summary_oc -> order_to_currency_summary_oc (DECIMAL(15,2))
- discount_summary_oc -> order_discount_summary_oc (DECIMAL(15,2))
- tax_summary_oc -> order_tax_summary_oc (DECIMAL(15,2))
- total_summary_oc -> order_total_summary_oc (DECIMAL(15,2))
- liquidate_amount_oc -> order_liquidate_amount_oc (DECIMAL(15,2))
- sale_order_amount_oc -> order_sale_order_amount_oc (DECIMAL(15,2))
- total_receipted_amount_oc -> order_total_receipted_amount_oc (DECIMAL(15,2))
- balance_receipt_amount_oc -> order_balance_receipt_amount_oc (DECIMAL(15,2))
- invoiced_amount_oc -> order_invoiced_amount_oc (DECIMAL(15,2))

Nhóm item_* (sale_order_product_mappings[])
- id -> item_id (BIGINT)
- product_code -> item_product_code (NVARCHAR(50))
- unit -> item_unit (NVARCHAR(20))
- usage_unit -> item_usage_unit (NVARCHAR(20))
- price -> item_price (DECIMAL(15,2))
- amount -> item_amount (DECIMAL(10,2))
- usage_unit_amount -> item_usage_unit_amount (DECIMAL(10,2))
- usage_unit_price -> item_usage_unit_price (DECIMAL(15,2))
- total -> item_total (DECIMAL(15,2))
- to_currency -> item_to_currency (DECIMAL(15,2))
- discount -> item_discount (DECIMAL(15,2))
- tax -> item_tax (DECIMAL(15,2))
- tax_percent -> item_tax_percent (NVARCHAR(100))
- discount_percent -> item_discount_percent (DECIMAL(5,2))
- price_after_tax -> item_price_after_tax (DECIMAL(15,2))
- price_after_discount -> item_price_after_discount (DECIMAL(15,2))
- to_currency_after_discount -> item_to_currency_after_discount (DECIMAL(15,2))
- description -> item_description (NVARCHAR(MAX))
- description_product -> item_description_product (NVARCHAR(MAX))
- stock_name -> item_stock_name (NVARCHAR(255))
- batch_number -> item_batch_number (NVARCHAR(100))
- serial_number -> item_serial_number (NVARCHAR(100))
- expire_date -> item_expire_date (DATETIME2)
- height -> item_height (DECIMAL(10,2))
- width -> item_width (DECIMAL(10,2))
- length -> item_length (DECIMAL(10,2))
- radius -> item_radius (DECIMAL(10,2))
- mass -> item_mass (DECIMAL(10,2))
- exist_amount -> item_exist_amount (DECIMAL(10,2))
- shipping_amount -> item_shipping_amount (DECIMAL(10,2))
- sort_order -> item_sort_order (INT)
- ratio -> item_ratio (DECIMAL(10,4))
- operator -> item_operator (NVARCHAR(20))
- promotion -> item_promotion (NVARCHAR(MAX))
- is_promotion -> item_is_promotion (BIT)
- custom_field1 -> item_custom_field1 (DECIMAL(15,2))
- produced_quantity -> item_produced_quantity (DECIMAL(10,2))
- quantity_ordered -> item_quantity_ordered (DECIMAL(10,2))
- sale_order_product -> item_sale_order_product (NVARCHAR(MAX))
- to_currency_oc -> item_to_currency_oc (DECIMAL(15,2))
- discount_oc -> item_discount_oc (DECIMAL(15,2))
- tax_oc -> item_tax_oc (DECIMAL(15,2))
- total_oc -> item_total_oc (DECIMAL(15,2))
- to_currency_oc_after_discount -> item_to_currency_oc_after_discount (DECIMAL(15,2))

Ghi chú chung cho tất cả endpoint MISA (customers, contacts, products, stocks, sale_orders)
- Chuẩn hoá thời gian: mọi trường thời gian dạng ISO 8601 có offset đều parse UTC rồi lưu DATETIME2 tz-naive theo giờ Việt Nam (+07).
- Số/tiền: ép kiểu theo schema DECIMAL đã định (ví dụ customers/products dùng 2 chữ số thập phân; sale_orders có một số trường 4 chữ số thập phân như exchange_rate (10,4)).
- Boolean: map chính xác True/False → BIT (1/0).
- Chuỗi: giới hạn NVARCHAR theo độ dài schema; các trường mô tả/danh sách dài hoặc JSON lưu NVARCHAR(MAX).
- Null/NaN/NaT: thay bằng NULL trước khi bind vào SQL Server để tránh lỗi kiểu.
- Sale Orders Flattened: giữ convention tiền tố order_* cho trường cấp đơn, item_* cho trường cấp dòng hàng; các field còn lại 1–1 với tên trường API.
- ETL metadata: mọi bảng đều có etl_created_at, etl_updated_at (giờ VN), etl_batch_id, etl_source để audit đồng nhất.


7) FULL LOAD VS INCREMENTAL
- Full load:
  • TikTok Shop: lấy từ ngày nghiệp vụ cố định (ví dụ 01/07/2024) → transform phẳng → load replace staging.
  • Shopee: lấy từ ngày nghiệp vụ cố định, (ví dụ ngày 01/07/2024), chia khoảng thời gian (≤10 ngày/lần), lấy danh sách đơn và chi tiết theo batch; transform 6 bảng; xoá theo thứ tự an toàn (bảng con → bảng cha) rồi insert.
  • MISA CRM:  lấy toàn bộ dữ liệu hiện có (không cố định mốc ngày; duyệt phân trang hết dữ liệu), quét toàn bộ endpoint; truncate-then-insert cho đồng bộ ban đầu.
- Incremental:
  • TikTok Shop: lọc theo update_time; upsert theo (order_id, item_id).
  • Shopee: lọc danh sách theo update_time; lấy detail → upsert 6 bảng theo khoá tự nhiên.
  • MISA CRM: lọc theo trường thời gian modified/updated (UTC), giới hạn trang để chỉ lấy phần thay đổi.

8) CHẤT LƯỢNG DỮ LIỆU VÀ HIỆU NĂNG
- Khử trùng lặp theo khoá trước khi nạp/merge.
- Làm sạch NaN/NaT/chuỗi rỗng → NULL để tránh lỗi bind ODBC/SQL Server.
- Kiểm soát batch size để không vượt ngưỡng 2100 tham số của SQL Server.
- Chuẩn hoá/giới hạn độ dài chuỗi theo schema staging.
- Ghi log chi tiết; có kịch bản kiểm thử kết nối/token và truy xuất cơ bản.

9) QUY TRÌNH VẬN HÀNH RÚT GỌN
- B1: Thiết lập .env (DB, TikTok, Shopee, MISA) và khởi tạo schema/tables staging, bảng điều khiển token.
- B2: Chạy full load theo thứ tự đã xác định (Shopee trước, TikTok và MISA sau) để đồng bộ lịch sử.
- B3: Lên lịch incremental 15 phút.
- B4: Giám sát log/metrics; theo dõi thống kê nạp; xử lý cảnh báo.

HẾT
